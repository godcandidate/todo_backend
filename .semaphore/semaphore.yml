version: v1.0
name: CI Pipeline for MyApp
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
blocks:
  - name: Build Environment
    task:
      jobs:
        - name: Build Environment
          commands:
            - checkout
            - sem-version node 22.11.0
            - cache restore node-modules-cache
            - npm install
            - cache store node-modules-cache node_modules
        - name: Validate Commits
          commands:
            - checkout
            - sem-version node 22.11.0
            - |
              commits=$(git rev-list origin/main..HEAD)
              for commit in $commits; do
                git show --quiet $commit --format='%B' | npx commitlint --verbose || exit 1
              done
  - name: Linter and Tester
    task:
      jobs:
        - name: Run Linter
          commands:
            - checkout
            - sem-version node 22.11.0
            - cache restore node-modules-cache
            - npm run lint
        - name: Run Tests
          commands:
            - checkout
            - sem-version node 22.11.0
            - cache restore node-modules-cache
            - npm run test
  - name: Deploy to DockerHub
    task:
      jobs:
        - name: Push Docker Image
          commands:
            - checkout
            - sem-version node 22.11.0
            # Docker login
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - echo "Building Docker image with tag $SEMAPHORE_GIT_TAG"
            - docker build -t $DOCKERHUB_USERNAME/todo-web-app-backend:$SEMAPHORE_GIT_TAG -t $DOCKERHUB_USERNAME/todo-web-app-backend:latest .
            - echo "Pushing Docker image to DockerHub"
            - docker push $DOCKERHUB_USERNAME/todo-web-app-backend:$SEMAPHORE_GIT_TAG
            - docker push $DOCKERHUB_USERNAME/todo-web-app-backend:latest
      secrets:
        - name: Docker
    run:
      when: tag =~ '.*'
