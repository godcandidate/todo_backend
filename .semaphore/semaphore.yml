version: v1.0
name: CI Pipeline for MyApp
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
blocks:
  - name: Build Environment
    task:
      jobs:
        - name: Build Environment
          commands:
            - checkout
            - sem-version node 22.11.0
            - cache restore node-modules-cache
            - npm install
            - cache store node-modules-cache node_modules
        - name: Validate Commits
          commands:
            - checkout
            - sem-version node 22.11.0
            - |
              commits=$(git rev-list origin/main..HEAD)
              for commit in $commits; do
                git show --quiet $commit --format='%B' | npx commitlint --verbose || exit 1
              done
  - name: Linter and Tester
    task:
      jobs:
        - name: Run Linter
          commands:
            - checkout
            - sem-version node 22.11.0
            - cache restore node-modules-cache
            - npm run lint
        - name: Run Tests
          commands:
            - checkout
            - sem-version node 22.11.0
            - cache restore node-modules-cache
            - npm run test
  - name: Deploy to DockerHub
    task:
      jobs:
        - name: Push Docker Image
          commands:
            - checkout
            - sem-version node 22.11.0
            - |
              # Fetch the latest tag from the Git repo
              LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
              # If no tag exists, start from v1.0
              if [ -z "$LATEST_TAG" ]; then
                LATEST_TAG="v1.0"
              fi
              # Increment the tag version (e.g., v1.0 -> v1.1)
              NEW_TAG=$(echo $LATEST_TAG | awk -F. -v OFS=. '{$NF++; print $0}')
              echo "Building Docker image with tag $NEW_TAG"
              docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_PASSWORD"
              docker build -t $DOCKERHUB_USERNAME/todo-web-app-backend:$NEW_TAG -t $DOCKERHUB_USERNAME/todo-web-app-backend:latest .
              docker push $DOCKERHUB_USERNAME/todo-web-app-backend:$NEW_TAG
              docker push $DOCKERHUB_USERNAME/todo-web-app-backend:latest
      secrets:
        - name: Docker
    run:
      when: tag =~ '.*'
